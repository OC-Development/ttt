<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Garage + Keys — Rebuilt Panels</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800&family=Inter:wght@500;700&family=Roboto+Mono:wght@700&display=swap" rel="stylesheet">

  <!-- Font Awesome (SRI OK) -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
        integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>

  <style>
    :root{
      /* Blue/Cyan palette */
      --accentA:#00A8E8;      /* blue */
      --accentB:#00D4FF;      /* cyan */
      --panel-bg: rgba(10,15,25,.96);
      --panel-border: rgba(0,168,232,.15);
      --card: #0a0f19;
      --hover:#0d1420;
      --chip:#0b1219;
      --chip-border:#1a3a52;
      --text:#e8f4ff;
      --text-d:#8fa9c4;
      --shadow: 0 20px 60px rgba(0,0,0,.6);
    }

    *{box-sizing:border-box}
    html,body{ margin:0; background:transparent; color:var(--text); font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,sans-serif; user-select:none; }

    /* ===================== GARAGE PANEL (LEFT) ===================== */
    .garage-root{ position:absolute; left:min(1.6vw,18px); top:2vh; bottom:2vh; width: clamp(340px, 28vw, 460px); }
    .panel{ height:100%; display:flex; flex-direction:column; overflow:hidden; background:var(--panel-bg); border:1px solid var(--panel-border); border-radius:16px; box-shadow:var(--shadow); backdrop-filter: blur(8px); }

    .panel-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:16px 18px 12px; border-bottom:1px solid var(--panel-border); background:linear-gradient(180deg, rgba(0,168,232,.08), transparent); }
    .title{ font:800 clamp(22px, 2.2vw, 28px)/1 Montserrat,Inter,sans-serif; color:#e8f4ff; }
    .subtitle{ color:var(--text-d); font-size:12px; margin-top:5px; }
    .close{ all:unset; width:36px; height:36px; display:grid; place-items:center; border-radius:10px; color:#a8c8e4; cursor:pointer; transition:.2s ease; border:1px solid transparent; }
    .close:hover{ background:rgba(0,168,232,.12); color:#00D4FF; border-color:rgba(0,168,232,.3); }

    .search{ display:flex; align-items:center; gap:10px; margin:14px 16px; padding:11px 14px; background:#080d16; border:1px solid var(--panel-border); border-radius:12px; color:var(--text-d); transition:.2s ease; }
    .search:focus-within{ border-color:rgba(0,168,232,.4); box-shadow: 0 0 0 3px rgba(0,168,232,.08); }
    .search i{ color:#5a8eb5; }
    .search input{ all:unset; flex:1; color:#e8f4ff; font-size:14px; }

    .vehicle-list{ flex:1; overflow:auto; padding:0 10px 14px; display:flex; flex-direction:column; gap:10px; overscroll-behavior:contain }

    .card{ background:#0a0f19; border:1px solid var(--panel-border); border-radius:12px; padding:12px; transition:.2s ease; cursor:pointer; }
    .card:hover{ background:#0d1420; border-color:rgba(0,168,232,.25); box-shadow: 0 4px 16px rgba(0,0,0,.3); }
    .card.open{ background:#0b1219; border-color:rgba(0,168,232,.4); box-shadow: 0 8px 24px rgba(0,0,0,.4), inset 0 1px 0 rgba(0,168,232,.15); }

    .head{ display:flex; align-items:center; justify-content:space-between; gap:10px }
    .left{ display:flex; align-items:center; gap:10px; min-width:0 }
    .star{ width:28px; height:28px; display:grid; place-items:center; border-radius:8px; background:rgba(0,168,232,.1); border:1px solid rgba(0,168,232,.3); color:#00D4FF; }
    .name{ display:inline-flex; align-items:center; gap:6px; padding:7px 12px; border-radius:8px; background:rgba(0,168,232,.08); border:1px solid rgba(0,168,232,.2); font:800 13px/1 Montserrat,Inter,sans-serif; letter-spacing:.4px; color:#e8f4ff; text-transform:uppercase; white-space:nowrap; max-width:240px; overflow:hidden; text-overflow:ellipsis; }
    .badge{ display:inline-flex; align-items:center; gap:6px; padding:6px 12px; border-radius:999px; border:1px solid rgba(0,168,232,.3); background:rgba(0,168,232,.12); color:#a8d8ff; font-size:12px; font-weight:600; }
    .badge i{ color:#00D4FF; }

    .body{ margin-top:12px; border:1px solid var(--panel-border); border-radius:12px; padding:14px; background:#080d15; }
    .grid{ display:grid; grid-template-columns: 1fr auto; gap:14px; align-items:center; }

    .stats{ display:flex; flex-direction:column; gap:12px }
    .srow{ display:grid; grid-template-columns: 30px 1fr 52px; gap:12px; align-items:center; }

    .ico{ width:30px; height:30px; border-radius:8px; background:rgba(0,168,232,.08); border:1px solid rgba(0,168,232,.25); display:flex; align-items:center; justify-content:center; }
    .ico i{ display:block; line-height:1; font-size:14px; color:#00D4FF; }

    .bar{ height:16px; border-radius:999px; background:#080d15; border:1px solid rgba(0,168,232,.2); overflow:hidden; box-shadow:inset 0 2px 4px rgba(0,0,0,.3); }
    .bar>i{ display:block; height:100%; width:35%; background:linear-gradient(90deg,var(--accentA),var(--accentB)); box-shadow: 0 0 8px rgba(0,168,232,.4); }
    .pct{ min-width:52px; text-align:center; padding:7px 8px; border-radius:8px; background:rgba(0,168,232,.1); border:1px solid rgba(0,168,232,.3); color:#e8f4ff; font:800 12px/1 Inter,sans-serif; }

    .plate{ position: relative; width: clamp(110px, 11vw, 160px); aspect-ratio: 5 / 2; background: #0000 url("./icons/plate1.png") center / contain no-repeat; display:flex; align-items:center; justify-content:center; border-radius: 10px; transform: translateX(8px); }
    .plate .num{ position: absolute; left: 50%; top: 52%; transform: translate(-50%, -50%); font-family: "Roboto Mono", ui-monospace, Menlo, monospace; font-weight: 800; letter-spacing: 1.6px; font-size: clamp(15px, 1.1vw, 18px); color: #1b2b3d; text-shadow: 0 1px 0 rgba(255,255,255,.45) }

    .actions{ display:flex; align-items:center; gap:8px; justify-content:flex-end; flex-wrap:wrap; }
    .btn{ all:unset; cursor:pointer; font-weight:800; font-size:13px; border-radius:10px; padding:9px 16px; background:rgba(0,168,232,.12); color:#e8f4ff; border:1px solid rgba(0,168,232,.3); transition:.2s ease; }
    .btn:hover{ background:rgba(0,168,232,.18); border-color:rgba(0,168,232,.5); box-shadow: 0 4px 12px rgba(0,168,232,.2); }
    .btn-eye{ width:40px; height:40px; display:grid; place-items:center; border-radius:10px; background:rgba(0,168,232,.1); border:1px solid rgba(0,168,232,.3); color:#00D4FF; transition:.2s ease; }
    .btn-eye:hover{ background:rgba(0,168,232,.18); border-color:rgba(0,168,232,.5); }

    @media (max-height: 700px){ .search{ margin:10px 12px } .plate{ transform: translateX(4px) } .pct{ min-width:46px; padding:5px 6px } .srow{ grid-template-columns: 28px 1fr 50px } }

    /* ===================== KEYS OVERLAY (CENTER) — REDESIGNED ===================== */
    .keys-overlay{position:fixed;inset:0;background:rgba(5,10,18,.88);display:none;align-items:center;justify-content:center;padding:20px;backdrop-filter:blur(6px)}
    .keys-panel{width:min(1140px,95vw);max-height:94vh;background:#0a1420;border:1px solid rgba(0,168,232,.25);border-radius:14px;box-shadow:0 32px 80px rgba(0,0,0,.75);display:flex;flex-direction:column;overflow:hidden}

    .keys-head{display:flex;align-items:flex-start;justify-content:space-between;padding:20px 24px 18px;border-bottom:1px solid rgba(0,168,232,.2)}
    .keys-title{display:flex;align-items:center;gap:10px;font-size:22px;font-weight:800;color:#e8f4ff}
    .keys-title i{color:#00D4FF;font-size:20px}
    .keys-sub{color:#7b99b8;font-size:13px;margin-top:3px;font-weight:400}
    .keys-actions{display:flex;align-items:center;gap:12px}
    .keys-chip-btn{all:unset;cursor:pointer;padding:8px 18px;border:1px solid rgba(0,168,232,.35);border-radius:8px;background:rgba(0,168,232,.12);color:#7db9e0;font-size:13px;font-weight:600;transition:.2s ease}
    .keys-chip-btn:hover{background:rgba(0,168,232,.18);border-color:rgba(0,168,232,.5)}

    .keys-close{all:unset;cursor:pointer;width:36px;height:36px;display:grid;place-items:center;border-radius:8px;color:#8fa9c4;transition:.2s ease}
    .keys-close:hover{background:rgba(255,255,255,.08);color:#fff}

    .keys-toolbar{display:flex;gap:10px;align-items:center;padding:16px 20px;border-bottom:1px solid rgba(0,168,232,.15)}
    .keys-search{flex:1;display:flex;align-items:center;gap:12px;background:#07101a;border:1px solid rgba(0,168,232,.2);border-radius:10px;padding:11px 16px;color:#6b89a5;transition:.2s ease}
    .keys-search:focus-within{border-color:rgba(0,168,232,.45);background:#08121c}
    .keys-search i{color:#4a7ca0;font-size:14px}
    .keys-search input{all:unset;flex:1;color:#c8dff5;font-size:14px}
    .keys-search input::placeholder{color:#5a7a95}

    .keys-btn-toolbar{all:unset;cursor:pointer;border-radius:8px;padding:10px 16px;font-weight:600;font-size:13px;border:1px solid rgba(0,168,232,.25);background:#0c1824;color:#9cb8d0;transition:.2s ease;white-space:nowrap}
    .keys-btn-toolbar:hover{background:#0f1d2a;border-color:rgba(0,168,232,.4)}

    .keys-content{display:grid;grid-template-columns:1fr 1fr;gap:18px;padding:18px;overflow:hidden;min-height:500px}

    .keys-col{display:flex;flex-direction:column;min-height:0;background:#08111c;border:1px solid rgba(0,168,232,.2);border-radius:10px;overflow:hidden}
    .keys-col-header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(0,168,232,.18);background:#0a1420}
    .keys-col-title{display:flex;align-items:center;gap:10px;font-weight:700;color:#d4e6f8;font-size:15px}
    .keys-col-title i{color:#00D4FF;font-size:16px}
    .keys-count-badge{padding:4px 10px;border-radius:12px;background:rgba(0,168,232,.15);color:#7db9e0;font-size:12px;font-weight:600}
    .keys-sub-inline{color:#6b89a5;font-weight:400;font-size:13px}
    .keys-sel-plate{padding:5px 12px;border-radius:6px;background:rgba(0,168,232,.15);border:1px solid rgba(0,168,232,.3);color:#7db9e0;font-size:12px;font-weight:800;letter-spacing:1px;font-family:"Roboto Mono", monospace}

    .keys-list{flex:1;overflow:auto;overscroll-behavior:contain}

    .keys-veh-row{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;border-bottom:1px solid rgba(0,168,232,.08);transition:.15s ease}
    .keys-veh-row:hover{background:rgba(0,168,232,.06)}
    .keys-veh-left{display:flex;align-items:center;gap:12px;min-width:0;flex:1}
    .keys-veh-plate{padding:8px 14px;border-radius:8px;background:#0a1420;border:1px solid rgba(0,168,232,.25);color:#7db9e0;font-size:13px;font-weight:900;letter-spacing:1.4px;font-family:"Roboto Mono",monospace;flex-shrink:0}
    .keys-veh-info{min-width:0;flex:1}
    .keys-veh-name{font-weight:700;color:#d4e6f8;font-size:14px;margin-bottom:2px}
    .keys-veh-meta{color:#5a7a95;font-size:12px}
    .keys-veh-right{display:flex;align-items:center;gap:8px}
    .keys-veh-badge{padding:6px 12px;border-radius:6px;border:1px solid rgba(0,168,232,.25);background:rgba(0,168,232,.1);color:#6b99c0;font-size:12px;font-weight:600;display:flex;align-items:center;gap:6px}
    .keys-veh-badge i{font-size:11px}
    .keys-manage-btn{all:unset;cursor:pointer;padding:8px 14px;border-radius:6px;border:1px solid rgba(0,168,232,.3);background:rgba(0,168,232,.12);color:#8fb8dc;font-size:12px;font-weight:700;transition:.15s ease;display:flex;align-items:center;gap:6px}
    .keys-manage-btn:hover{background:rgba(0,168,232,.18);border-color:rgba(0,168,232,.45)}
    .keys-manage-btn i{font-size:12px}

    .keys-shares{flex:1;overflow:auto;overscroll-behavior:contain}

    .keys-empty{padding:40px 20px;color:#6b89a5;text-align:center;font-size:14px}

    .keys-form{display:grid;grid-template-columns:repeat(3, 1fr);grid-template-rows: auto auto;gap:10px 12px;padding:16px;border-top:1px solid rgba(0,168,232,.18);background:#0a1420}
    .keys-form-label{color:#7b99b8;font-size:12px;font-weight:600;padding-bottom:2px}
    .keys-form-input{all:unset;background:#07101a;border:1px solid rgba(0,168,232,.25);border-radius:8px;color:#c8dff5;padding:10px 12px;font-size:13px;transition:.2s ease}
    .keys-form-input:focus{border-color:rgba(0,168,232,.5);background:#08121c;box-shadow: 0 0 0 3px rgba(0,168,232,.08)}
    .keys-form-input::placeholder{color:#5a7a95}
    .keys-share-btn{all:unset;cursor:pointer;grid-column:1 / -1;padding:11px 18px;border-radius:8px;background:linear-gradient(135deg,#00A8E8,#00D4FF);color:#052533;font-size:13px;font-weight:800;text-align:center;transition:.2s ease;margin-top:4px}
    .keys-share-btn:hover{transform:translateY(-1px);box-shadow: 0 6px 20px rgba(0,168,232,.35)}
    .keys-share-btn i{margin-right:6px}

    .keys-toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:#0a1420;border:1px solid rgba(0,168,232,.3);border-radius:10px;color:#d4e6f8;padding:12px 20px;box-shadow:0 12px 40px rgba(0,0,0,.6);display:none;backdrop-filter:blur(10px)}
    .keys-toast.show{display:block}

    @media (max-width: 1100px){
      .keys-content{grid-template-columns: 1fr}
    }
  </style>
</head>
<body>

  <!-- ===================== GARAGE ===================== -->
  <div id="app" class="garage-root" style="display:none;">
    <div class="panel">
      <div class="panel-header">
        <div>
          <div class="title">Garage</div>
          <div class="subtitle">Manage, preview & track your vehicles</div>
        </div>
        <button id="btnClose" class="close" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="search" title="Search by name or plate (Ctrl+F)">
        <i class="fa-solid fa-magnifying-glass"></i>
        <input id="search" type="text" placeholder="Search for Vehicle" autocomplete="off">
      </div>

      <div id="vehicleList" class="vehicle-list"></div>
    </div>
  </div>

  <!-- ===================== KEYS OVERLAY ===================== -->
  <div id="keysOverlay" class="keys-overlay" role="dialog" aria-modal="true" aria-labelledby="keysTitle">
    <div class="keys-panel">
      <div class="keys-head">
        <div>
          <div id="keysTitle" class="keys-title"><i class="fa-solid fa-key"></i> Vehicle Keys</div>
          <div class="keys-sub">Share, update roles, and manage expiries</div>
        </div>
        <div class="keys-actions">
          <button class="keys-chip-btn">Secure Share</button>
          <button class="keys-close" id="keysClose" aria-label="Close keys"><i class="fa-solid fa-xmark"></i></button>
        </div>
      </div>

      <div class="keys-toolbar">
        <div class="keys-search">
          <i class="fa-solid fa-magnifying-glass"></i>
          <input id="keysQ" placeholder="Search by vehicle, plate or garage...">
        </div>
        <button id="keysFilterState" class="keys-btn-toolbar" title="Filter by state">All states</button>
        <button id="keysSort" class="keys-btn-toolbar" title="Sort list">Garage A→Z</button>
        <button class="keys-btn-toolbar" id="keysRefresh" title="Refresh"><i class="fa-solid fa-rotate-right"></i> Refresh</button>
      </div>

      <div class="keys-content">
        <!-- Vehicles -->
        <div class="keys-col">
          <div class="keys-col-header">
            <div class="keys-col-title"><i class="fa-solid fa-car"></i> My Vehicles</div>
            <div id="keysCount" class="keys-count-badge">—</div>
          </div>
          <div id="keysVehList" class="keys-list"></div>
        </div>

        <!-- Shares -->
        <div class="keys-col">
          <div class="keys-col-header">
            <div class="keys-col-title">
              <i class="fa-solid fa-users-gear"></i>
              <span>Shares</span>
              <span class="keys-sub-inline">for plate:</span>
              <span id="keysSelPlate" class="keys-sel-plate">—</span>
            </div>
          </div>

          <div id="keysShareList" class="keys-shares"></div>

          <div class="keys-form">
            <label class="keys-form-label">Player (ID) or CitizenID</label>
            <label class="keys-form-label">Role</label>
            <label class="keys-form-label">Duration (hours)</label>

            <input id="keysTarget" class="keys-form-input" placeholder="e.g. 12 or QBC123...">
            <select id="keysRole" class="keys-form-input">
              <option value="viewer">Viewer (track only)</option>
              <option value="driver">Driver (take/park)</option>
              <option value="manager">Manager (full)</option>
            </select>
            <input id="keysHours" class="keys-form-input" type="text" placeholder="0 = no expiry">

            <button id="keysShareBtn" class="keys-share-btn"><i class="fa-solid fa-plus"></i> Share</button>
          </div>
        </div>
      </div>

    </div>
  </div>

  <div id="keysToast" class="keys-toast"></div>

  <script>
    // ===================== Shared helpers =====================
    const RES  = (typeof GetParentResourceName === 'function') ? GetParentResourceName() : 'qb-garages';
    const post = (name, data={}) => fetch(`https://${RES}/${name}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});
    const esc  = (s)=> (s??'').toString().replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));
    const pct  = (n)=> Math.max(0, Math.min(100, Math.round(Number(n||0))));

    // Focus search with Ctrl+F inside panel
    window.addEventListener('keydown',(e)=>{ if(e.ctrlKey && e.key.toLowerCase()==='f'){ const f=document.querySelector('.keys-overlay').style.display==='flex' ? document.getElementById('keysQ') : document.getElementById('search'); if(f){ e.preventDefault(); f.focus(); f.select?.(); }}});

    // ===================== GARAGE UI =====================
    function stateOf(v){
      const raw = v && (v.stateKey ?? v.state);
      if (typeof raw === 'number') return raw===1?'garaged':raw===2?'impound':'out';
      const s = String(raw??'').toLowerCase();
      if (s==='1'||s.includes('garag')) return 'garaged';
      if (s==='2'||s.includes('imp'))   return 'impound';
      if (s==='0'||s.includes('out'))   return 'out';
      return 'garaged';
    }

    const badgePlace = t => `<span class="badge"><i class="fa-solid fa-location-dot"></i>${esc(t)}</span>`;

    function headRow(v){
      return `
        <div class="head">
          <div class="left">
            <span class="star"><i class="fa-solid fa-car-rear"></i></span>
            <span class="name">${esc((v.display||v.name||'').toUpperCase())}</span>
          </div>
          ${v.location ? badgePlace(v.location) : ''}
        </div>`;
    }

    function statRow(iconCls, val){
      val = pct(val);
      return `
        <div class="srow">
          <span class="ico"><i class="${iconCls}" aria-hidden="true"></i></span>
          <div class="bar"><i style="width:${val}%"></i></div>
          <span class="pct">${val}</span>
        </div>`;
    }

    function expanded(v){
      const st = stateOf(v);
      const take  = st==='garaged' ? `<button class="btn" data-act="take">Take Out</button>` : '';
      const track = st==='out'     ? `<button class="btn" data-act="track">Track</button>` : '';
      const depot = st==='impound' ? `<button class="btn" data-act="depot">Pay & Retrieve</button>` : '';

      return `
        <div class="body">
          <div class="grid">
            <div class="stats">
              ${statRow('fa-solid fa-gas-pump', v.fuel)}
              ${statRow('fa-solid fa-gauge-high', v.engine)}
              ${statRow('fa-solid fa-car-side', v.body)}
            </div>
            <div style="display:flex;flex-direction:column;gap:10px;align-items:flex-end">
              <div class="plate"><span class="num">${esc(v.plate||'PLATE')}</span></div>
              <div class="actions">
                ${take || track || depot}
                <button class="btn-eye" data-eye data-model="${esc(v.model)}" data-plate="${esc(v.plate||'')}" title="Preview">
                  <i class="fa-regular fa-eye"></i>
                </button>
              </div>
            </div>
          </div>
        </div>`;
    }

    function makeCard(v, open){
      const el = document.createElement('div');
      el.className = 'card'+(open?' open':'');
      el.dataset.model = v.model || '';
      el.innerHTML = headRow(v) + (open?expanded(v):'');

      el.addEventListener('click',(e)=>{
        if (e.target.closest('button')) return;
        const list = document.getElementById('vehicleList');
        list.querySelectorAll('.card.open').forEach(it=>{
          if(it!==el){ if (it.__v && it.__v.plate) nui('nui:hover_preview',{on:false, plate: it.__v.plate}); it.classList.remove('open'); it.innerHTML = headRow(it.__v); }
        });
        if(el.classList.contains('open')){ el.classList.remove('open'); el.innerHTML = headRow(v); nui('nui:hover_preview',{on:false, plate: v.plate}); }
        else { el.classList.add('open'); el.innerHTML = headRow(v) + expanded(v); bindActions(el, v); }
      });

      bindActions(el, v);
      el.__v = v;
      return el;
    }

    function bindActions(root, v){
      root.querySelectorAll('[data-act]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const a = btn.getAttribute('data-act');
          if(a==='take')  post('nui:take_out',{plate:v.plate,model:v.model,info:v.raw});
          if(a==='track') post('nui:track',{plate:v.plate});
          if(a==='depot') post('nui:depot',{vehicle:v.raw});
        });
      });
      const eye = root.querySelector('[data-eye]');
      if(eye){
        const model = eye.getAttribute('data-model');
        const plate = eye.getAttribute('data-plate') || v.plate || '';
        eye.addEventListener('mouseenter', ()=> nui('nui:hover_preview',{on:true, model, plate}));
        eye.addEventListener('mouseleave', ()=> nui('nui:hover_preview',{on:false, plate}));
      }
    }

    function render(list){
      const host = document.getElementById('vehicleList');
      host.innerHTML = '';
      if(!list || list.length===0){ const d=document.createElement('div'); d.style.padding='12px'; d.style.color='var(--text-d)'; d.textContent='No vehicles found.'; host.appendChild(d); return; }
      list.forEach((v,i)=> host.appendChild(makeCard(v, i===0)));
    }

    function nui(name,data={}){ return fetch(`https://${RES}/${name}`,{method:'POST',headers:{'Content-Type':'application/json; charset=UTF-8'},body:JSON.stringify(data)}); }

    let state={vehicles:[]};
    window.addEventListener('message',(e)=>{
      const d=e.data||{};
      if(d.action==='open'){
        state={...state,...d.payload};
        document.getElementById('app').style.display='block';
        document.getElementById('search').value='';
        render(state.vehicles);
      }else if(d.action==='close'){
        closeUI();
      }else if(d.action==='update'){
        state.vehicles=d.vehicles||state.vehicles; render(state.vehicles);
      }else if(d.action==='keysui:open'){
        keysOpen();
      }
    });

    function closeUI(){ document.getElementById('app').style.display='none'; nui('nui:hover_preview',{on:false}); post('nui:close',{}); }
    document.getElementById('btnClose').addEventListener('click', closeUI);
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape'){ if(keysIsOpen()) keysClose(); else closeUI(); } });

    document.getElementById('search').addEventListener('input',(e)=>{
      const q=e.target.value.trim().toLowerCase();
      if(!q) return render(state.vehicles);
      render(state.vehicles.filter(v => (v.name||'').toLowerCase().includes(q) || (v.display||'').toLowerCase().includes(q) || (v.plate||'').toLowerCase().includes(q)));
    });

    // ===================== KEYS UI (Rebuilt) =====================
    const keysOverlay = document.getElementById('keysOverlay');
    const keysToast   = document.getElementById('keysToast');
    const postNUI     = (name, data={}) => fetch(`https://${RES}/${name}`, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(data)});

    const KEYS = { vehicles:[], shares:{}, selectedPlate:null, filtered:[], sort:'garage', filterState:'' };

    function keysIsOpen(){ return keysOverlay.style.display === 'flex'; }
    function keysOpen(){ keysOverlay.style.display = 'flex'; KEYS.selectedPlate = null; document.getElementById('keysSelPlate').textContent = '—'; document.getElementById('keysQ').value = ''; keysRefresh(); }
    function keysClose(){ postNUI('keysui:close', {}).then(()=> keysOverlay.style.display='none'); }

    document.getElementById('keysClose').addEventListener('click', keysClose);
    document.getElementById('keysRefresh').addEventListener('click', keysRefresh);
    document.getElementById('keysShareBtn').addEventListener('click', keysDoShare);
    document.getElementById('keysQ').addEventListener('input', (e)=> keysFilter(e.target.value));
    document.getElementById('keysSort').addEventListener('change', (e)=>{ KEYS.sort=e.target.value; keysRenderVehicles(); });
    document.getElementById('keysFilterState').addEventListener('change', (e)=>{ KEYS.filterState=e.target.value; keysRenderVehicles(); });

    function keysToastMsg(msg){ keysToast.textContent = msg; keysToast.classList.add('show'); setTimeout(()=> keysToast.classList.remove('show'), 1600); }

    function keysFormatState(s){ if (s === 1 || s === '1') return 'GARAGED'; if (s === 2 || s === '2') return 'IMPOUND'; return 'OUT'; }
    function keysPickName(v){ return (v.vehicle || v.model || '').toUpperCase(); }

    async function keysRefresh(){
      const data = await postNUI('keysui:fetch', {}).then(r=>r.json()).catch(()=>({vehicles:[],shares:{}}));
      KEYS.vehicles = data.vehicles || [];
      KEYS.shares   = data.shares   || {};
      const total = (KEYS.vehicles||[]).length; document.getElementById('keysCount').textContent = total? `${total} vehicle${total>1?'s':''}` : '—';
      if (KEYS.selectedPlate) { const still = KEYS.vehicles.some(v => (v.plate||'').toUpperCase() === KEYS.selectedPlate); if (!still) KEYS.selectedPlate = null; }
      document.getElementById('keysSelPlate').textContent = KEYS.selectedPlate || '—';
      keysFilter(document.getElementById('keysQ').value);
      keysRenderShares();
    }

    function keysFilter(q){
      q = (q||'').toLowerCase().trim();
      const src = KEYS.vehicles||[];
      KEYS.filtered = !q ? src.slice() : src.filter(v => (v.vehicle||'').toLowerCase().includes(q) || (v.plate||'').toLowerCase().includes(q) || (v.garage||'').toLowerCase().includes(q));
      keysRenderVehicles();
    }

    function sorters(){
      return {
        garage:(a,b)=> String(a.garage||'').localeCompare(String(b.garage||'')) || String(a.plate||'').localeCompare(String(b.plate||'')),
        state:(a,b)=> keysFormatState(a.state).localeCompare(keysFormatState(b.state)) || String(a.plate||'').localeCompare(String(b.plate||'')),
        fuel:(a,b)=> (b.fuel||0)-(a.fuel||0),
        engine:(a,b)=> (b.engine||0)-(a.engine||0),
      }
    }

    function keysRenderVehicles(){
      const host = document.getElementById('keysVehList');
      host.innerHTML = '';
      let list = KEYS.filtered.length ? KEYS.filtered.slice() : (KEYS.vehicles||[]).slice();
      if (KEYS.filterState){ list = list.filter(v => keysFormatState(v.state) === KEYS.filterState); }
      const srt = sorters()[KEYS.sort] || sorters().garage; list.sort(srt);
      if(!list || !list.length){ host.innerHTML = '<div class="keys-empty">No vehicles.</div>'; document.getElementById('keysCount').textContent='0 vehicles'; return; }

      document.getElementById('keysCount').textContent=`${list.length} vehicle${list.length>1?'s':''}`;

      list.forEach(v=>{
        const st = keysFormatState(v.state);
        const row = document.createElement('div');
        row.className = 'keys-veh-row';
        row.innerHTML = `
          <div class="keys-veh-left">
            <span class="keys-veh-plate">${esc((v.plate||'').toUpperCase())}</span>
            <div class="keys-veh-info">
              <div class="keys-veh-name">${esc(keysPickName(v))}</div>
              <div class="keys-veh-meta">${esc(st)} • Fuel ${Math.round(v.fuel||0)}% • Eng ${Math.round((v.engine||1000)/10)}%</div>
            </div>
          </div>
          <div class="keys-veh-right">
            <span class="keys-veh-badge"><i class="fa-solid fa-warehouse"></i> ${esc(v.garage || 'legionsquare')}</span>
            <button class="keys-manage-btn" data-plate="${esc((v.plate||'').toUpperCase())}"><i class="fa-solid fa-gear"></i> Manage</button>
          </div>`;
        row.querySelector('button[data-plate]').addEventListener('click', ()=>{ KEYS.selectedPlate = (v.plate||'').toUpperCase(); document.getElementById('keysSelPlate').textContent = KEYS.selectedPlate; keysRenderShares(); });
        host.appendChild(row);
      });
    }

    function relTimeFrom(exp){
      if(!exp) return 'no expiry';
      const t = Date.parse(exp); if(Number.isNaN(t)) return exp; // keep raw
      const diff = t - Date.now();
      const abs = Math.abs(diff);
      const h = Math.round(abs/3.6e6);
      if(diff>0) return `in ${h}h`;
      return `${h}h ago`;
    }

    function keysRenderShares(){
      const host = document.getElementById('keysShareList');
      host.innerHTML = '';
      const plate = KEYS.selectedPlate;
      if(!plate){ host.innerHTML = '<div class="keys-empty">Pick a vehicle from the left.</div>'; return; }
      const list = KEYS.shares[plate] || [];
      if(!list.length){ host.innerHTML = '<div class="keys-empty">No active shares for this plate.</div>'; return; }

      list.forEach(s=>{
        const expText = s.expires_at ? relTimeFrom(s.expires_at) : 'no expiry';
        const row = document.createElement('div');
        row.className = 'keys-veh-row';
        row.innerHTML = `
          <div class="keys-veh-left">
            <div class="keys-veh-info" style="padding-left:4px">
              <div class="keys-veh-name"><i class="fa-solid fa-user" style="font-size:12px;margin-right:6px;color:#5a9ec5"></i>${esc(s.shared_to_citizenid)}</div>
              <div class="keys-veh-meta">${esc(expText)}</div>
            </div>
          </div>
          <div class="keys-veh-right">
            <select class="keys-form-input" data-act="role" style="padding:8px 10px;font-size:12px;min-width:140px">
              <option value="viewer" ${s.role==='viewer'?'selected':''}>Viewer (track only)</option>
              <option value="driver" ${s.role==='driver'?'selected':''}>Driver (take/park)</option>
              <option value="manager" ${s.role==='manager'?'selected':''}>Manager (full)</option>
            </select>
            <button class="keys-manage-btn" data-act="revoke" style="border-color:#5b2530;background:#1a1214;color:#ffdadd"><i class="fa-solid fa-ban"></i> Revoke</button>
          </div>`;

        row.querySelector('[data-act="revoke"]').addEventListener('click', async ()=>{
          if(!confirm('Revoke this share?')) return;
          const r = await postNUI('keysui:revoke', { plate: plate, target: s.shared_to_citizenid }).then(r=>r.json()).catch(()=>({ok:false}));
          if(r.ok){ keysToastMsg('Revoked'); keysRefresh(); } else { keysToastMsg('Revoke failed'); }
        });
        row.querySelector('[data-act="role"]').addEventListener('change', async (e)=>{
          const role = e.target.value;
          const r = await postNUI('keysui:update', { plate: plate, target: s.shared_to_citizenid, role }).then(r=>r.json()).catch(()=>({ok:false}));
          if(r.ok){ keysToastMsg('Role updated'); keysRefresh(); } else { keysToastMsg('Update failed'); }
        });

        host.appendChild(row);
      });
    }

    async function keysDoShare(){
      if(!KEYS.selectedPlate){ keysToastMsg('Select a vehicle first'); return; }
      const target = document.getElementById('keysTarget').value.trim();
      const role   = document.getElementById('keysRole').value;
      const hours  = Number(document.getElementById('keysHours').value || 0);
      if(!target){ keysToastMsg('Enter target'); return; }
      const r = await postNUI('keysui:share', { plate: KEYS.selectedPlate, target, role, hours }).then(r=>r.json()).catch(()=>({ok:false}));
      if(r.ok){ keysToastMsg('Shared'); document.getElementById('keysTarget').value=''; document.getElementById('keysHours').value=''; keysRefresh(); }
      else { keysToastMsg(r.err || 'Share failed'); }
    }
  </script>
</body>
</html>
